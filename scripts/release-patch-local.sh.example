#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   cp scripts/release-patch-local.sh.example scripts/release-patch-local.sh
#   chmod +x scripts/release-patch-local.sh
#   ./scripts/release-patch-local.sh

repo_root="$(cd "$(dirname "$0")/.." && pwd)"
cd "$repo_root"

pkg_name="$(node -p "require('./package.json').name")"
pkg_version="$(node -p "require('./package.json').version")"
tag="v${pkg_version}"

if [[ -n "$(git status --porcelain)" ]]; then
  echo "Working tree is not clean. Commit/stash changes first."
  exit 1
fi

current_branch="$(git rev-parse --abbrev-ref HEAD)"
if [[ "$current_branch" != "main" ]]; then
  echo "You are on '$current_branch'. Switch to 'main' before release."
  exit 1
fi

echo "Running tests..."
pnpm test

echo "Checking npm for ${pkg_name}@${pkg_version}..."
if npm view "${pkg_name}@${pkg_version}" version >/dev/null 2>&1; then
  echo "${pkg_name}@${pkg_version} already exists on npm."
  echo "Creating a new patch release..."
  pnpm version patch
  echo "Pushing commit + tags..."
  git push origin main --follow-tags
  echo "Done. A new patch tag was pushed."
  exit 0
fi

echo "${pkg_name}@${pkg_version} is not on npm yet."
echo "Ensuring tag ${tag} points to current HEAD and pushing it..."
git tag -f "${tag}"
git push origin main
git push origin -f "refs/tags/${tag}"

echo "Done. This should trigger publish for ${tag}."
